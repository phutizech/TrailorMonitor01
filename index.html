<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Trailer Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Toastify -->
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"/>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f4f4f4;
      margin: 0;
      padding: 0 20px;
      max-width: 900px;
      margin: auto;
    }

    header {
      text-align: center;
      padding: 30px 0 10px;
    }

    header h1 {
      margin: 0;
      font-size: 28px;
    }

    .dashboard {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }

    .card {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      transition: transform 0.2s;
    }

    .card:hover {
      transform: translateY(-3px);
    }

    .status {
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 6px;
      display: inline-block;
      margin-left: 10px;
      transition: background 0.3s;
    }

    .ok { background: #4CAF50; color: white; }
    .warn { background: #f44336; color: white; }
    .on { background: #2196F3; color: white; }
    .off { background: #9E9E9E; color: white; }

    button {
      padding: 12px;
      margin: 5px 5px 10px 0;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      transition: background 0.3s;
    }

    .on-btn { background: #4CAF50; color: white; }
    .off-btn { background: #f44336; color: white; }

    canvas {
      width: 100%;
    }

    #eventLog {
      max-height: 180px;
      overflow-y: auto;
      padding: 10px;
      background: #fff;
      border-radius: 8px;
      font-size: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    @media (max-width: 768px) {
      .dashboard {
        grid-template-columns: 1fr;
      }

      button {
        width: 100%;
      }
    }
  </style>
</head>
<body>

<header>
  <h1>ðŸšš Trailer Monitoring Dashboard</h1>
</header>

<div class="dashboard">
  <div class="card">
    <h3>Battery Voltage: <span id="voltage">--</span> V</h3>
    <h4>Status: <span id="batteryStatus" class="status">--</span></h4>
    <h3>Temperature: <span id="temperature">--</span> Â°C</h3>
    <h4>Status: <span id="tempStatus" class="status">--</span></h4>
    <h4>Error: <span id="error">--</span></h4>
  </div>

  <div class="card">
    <h3>Controls</h3>
    <button class="on-btn" onclick="setSiren(true)">Turn Siren ON</button>
    <button class="off-btn" onclick="setSiren(false)">Turn Siren OFF</button><br>
    <button class="on-btn" onclick="setLights(true)">Turn Lights ON</button>
    <button class="off-btn" onclick="setLights(false)">Turn Lights OFF</button>

    <p>Siren: <span id="sirenStatus" class="status">--</span></p>
    <p>Lights: <span id="lightStatus" class="status">--</span></p>
  </div>
</div>

<div class="card" style="margin-top: 20px;">
  <h3>Voltage & Temperature Chart</h3>
  <canvas id="sensorChart"></canvas>
</div>

<div class="card" style="margin-top: 20px;">
  <h3>Event Log</h3>
  <div id="eventLog"></div>
</div>

<script>
  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyB6RdjqWt4hr6H0nD-xQyEdG-0AKZQ2rrc",
    authDomain: "trailermonitor-lpc01.firebaseapp.com",
    databaseURL: "https://trailermonitor-lpc01-default-rtdb.firebaseio.com",
    projectId: "trailermonitor-lpc01",
    storageBucket: "trailermonitor-lpc01.firebasestorage.app",
    messagingSenderId: "970596510424",
    appId: "1:970596510424:web:cb524237bf653d7d9685ad",
    measurementId: "G-93YWHECFJ3"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let voltageData = [];
  let tempData = [];
  const MAX_POINTS = 30;

  const ctx = document.getElementById('sensorChart').getContext('2d');
  const chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        {
          label: 'Voltage (V)',
          data: voltageData,
          borderColor: '#4CAF50',
          fill: false
        },
        {
          label: 'Temperature (Â°C)',
          data: tempData,
          borderColor: '#f44336',
          fill: false
        }
      ]
    },
    options: {
      animation: false,
      responsive: true,
      scales: {
        x: { display: false },
        y: { beginAtZero: true }
      }
    }
  });

  function updateChart(voltage, temp) {
    const time = new Date().toLocaleTimeString();
    chart.data.labels.push(time);
    voltageData.push(voltage);
    tempData.push(temp);

    if (voltageData.length > MAX_POINTS) {
      chart.data.labels.shift();
      voltageData.shift();
      tempData.shift();
    }

    chart.update();
  }

  function logEvent(message) {
    const log = document.getElementById("eventLog");
    const entry = document.createElement("p");
    entry.textContent = new Date().toLocaleTimeString() + " - " + message;
    log.prepend(entry);
  }

  function showToast(msg, type = "info") {
    Toastify({
      text: msg,
      duration: 3000,
      close: true,
      gravity: "top",
      position: "right",
      backgroundColor: type === "warn" ? "#f44336" : "#4CAF50"
    }).showToast();
  }

  db.ref("trailer").on("value", snapshot => {
    const data = snapshot.val() ?? {};
    const voltage = data.voltage ?? 0;
    const temp = data.temperature ?? 0;
    const error = data.error ?? "None";

    document.getElementById("voltage").innerText = voltage.toFixed(2);
    document.getElementById("temperature").innerText = temp.toFixed(1);
    document.getElementById("error").innerText = error;

    const batteryStatus = document.getElementById("batteryStatus");
    const tempStatus = document.getElementById("tempStatus");

    if (voltage < 11) {
      batteryStatus.innerText = "Low";
      batteryStatus.className = "status warn";
      showToast("Battery voltage is low!", "warn");
      logEvent("Battery low warning");
    } else {
      batteryStatus.innerText = "OK";
      batteryStatus.className = "status ok";
    }

    if (temp > 50) {
      tempStatus.innerText = "High";
      tempStatus.className = "status warn";
      showToast("Temperature is high!", "warn");
      logEvent("Temperature high warning");
    } else {
      tempStatus.innerText = "Normal";
      tempStatus.className = "status ok";
    }

    updateChart(voltage, temp);
  });

  db.ref("controls").on("value", snapshot => {
    const controls = snapshot.val() ?? {};
    const siren = controls.siren ?? false;
    const lights = controls.lights ?? false;

    const sirenEl = document.getElementById("sirenStatus");
    sirenEl.innerText = siren ? "ON" : "OFF";
    sirenEl.className = "status " + (siren ? "on" : "off");
    logEvent(`Siren turned ${siren ? "ON" : "OFF"}`);

    const lightsEl = document.getElementById("lightStatus");
    lightsEl.innerText = lights ? "ON" : "OFF";
    lightsEl.className = "status " + (lights ? "on" : "off");
    logEvent(`Lights turned ${lights ? "ON" : "OFF"}`);
  });

  function setSiren(state) {
    db.ref("controls/siren").set(state);
  }

  function setLights(state) {
    db.ref("controls/lights").set(state);
  }
</script>
</body>
</html>
